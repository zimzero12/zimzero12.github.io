<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>EchoDraw</title>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #header {
            width: 100%;
            text-align: center;
        }
        #main-container {
            display: flex;
            flex-direction: row;
            justify-content: center;
            width: 100%;
        }
        #editor-container {
            margin: 10px;
        }
        #display-container {
            margin: 10px;
        }
        #drawingCanvas {
            border: 2px solid #ccc;
            border-radius: 4px;
        }
        #button-bar {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        #runBtn {
            background-color: #4CAF50;
            color: white;
        }
        #saveBtn {
            background-color: #008CBA;
            color: white;
        }
        #shareBtn {
            background-color: #f44336;
            color: white;
        }
        #code-editor {
            background-color: #2d2d2d;
            color: #d4d4d4;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 10px;
            white-space: pre;
            font-family: "SF Mono", "Menlo", monospace;
            height: 200px;
            width: 380px;
            overflow-y: auto;
            resize: vertical;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>EchoDraw</h1>
        <p>Build with blocks, create your own custom blocks, then run, save, or share!</p>
    </div>

    <div id="main-container">
        <div id="editor-container">
            <h2>Visual Editor</h2>
            <div id="blocklyDiv" style="height: 520px; width: 600px;"></div>
        </div>
        <div id="display-container">
            <h2>Drawing Canvas</h2>
            <canvas id="drawingCanvas" width="400" height="400"></canvas>
            <div id="button-bar">
                <button id="runBtn" onclick="runCode()">Run Program</button>
                <button id="saveBtn" onclick="saveDrawing()">Save Drawing</button>
                <button id="shareBtn" onclick="shareProgram()">Share Program</button>
            </div>
            <h2>Code Editor</h2>
            <textarea id="code-editor"></textarea>
        </div>
    </div>

    <xml id="toolbox" style="display: none">
        <category name="Logic" colour="#5C81A6">
            <block type="controls_repeat_ext">
                <value name="TIMES">
                    <shadow type="math_number"><field name="NUM">4</field></shadow>
                </value>
            </block>
        </category>
        <category name="Drawing" colour="#5CA65C">
            <block type="draw_move_forward"></block>
            <block type="draw_turn_right"></block>
        </category>
        <category name="Artist" colour="#A65C81">
            <block type="draw_pen"></block>
            <block type="draw_set_color"></block>
            <block type="draw_set_thickness"></block>
        </category>
        <category name="Values" colour="#5C5CA6">
            <block type="math_number"><field name="NUM">100</field></block>
        </category>
        <category name="My Blocks" colour="#BF8052" custom="PROCEDURE"></category>
    </xml>

    <script>
        // =================================================================
        // PART 1: BLOCKLY SETUP (DEFINITIONS AND GENERATORS)
        // =================================================================

        Blockly.Blocks['draw_move_forward'] = {
            init: function() {
                this.appendValueInput("VALUE").setCheck("Number").appendField("move forward by");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(120);
            }
        };

        Blockly.Blocks['draw_turn_right'] = {
            init: function() {
                this.appendValueInput("VALUE").setCheck("Number").appendField("turn right by");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(120);
            }
        };

        Blockly.Blocks['draw_pen'] = {
            init: function() {
                this.appendDummyInput().appendField("pen").appendField(new Blockly.FieldDropdown([["down","DOWN"], ["up","UP"]]), "STATE");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(70);
            }
        };

        Blockly.Blocks['draw_set_color'] = {
            init: function() {
                this.appendDummyInput().appendField("set color to").appendField(new Blockly.FieldDropdown([["red","red"], ["blue","blue"], ["green","green"], ["yellow","yellow"], ["black","black"], ["orange","orange"]]), "COLOR");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(70);
            }
        };

        Blockly.Blocks['draw_set_thickness'] = {
            init: function() {
                this.appendValueInput("WIDTH").setCheck("Number").appendField("set thickness to");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(70);
            }
        };

        Blockly.EchoDraw = new Blockly.Generator('EchoDraw');
        Blockly.EchoDraw.forBlock['controls_repeat_ext'] = function(b) { const r = Blockly.EchoDraw.valueToCode(b,'TIMES',0)||'0'; const d = Blockly.EchoDraw.statementToCode(b,'DO'); return `repeat ${r}\n${d}end_repeat\n`; };
        Blockly.EchoDraw.forBlock['draw_move_forward'] = function(b) { const v = Blockly.EchoDraw.valueToCode(b,'VALUE',0)||'0'; return `move_forward ${v}\n`; };
        Blockly.EchoDraw.forBlock['draw_turn_right'] = function(b) { const v = Blockly.EchoDraw.valueToCode(b,'VALUE',0)||'0'; return `turn_right ${v}\n`; };
        Blockly.EchoDraw.forBlock['math_number'] = function(b) { return [String(b.getFieldValue('NUM')), 0]; };
        Blockly.EchoDraw.forBlock['draw_pen'] = function(b) { const s = b.getFieldValue('STATE'); return s === 'UP' ? 'pen_up\n' : 'pen_down\n'; };
        Blockly.EchoDraw.forBlock['draw_set_color'] = function(b) { const c = b.getFieldValue('COLOR'); return `set_color ${c}\n`; };
        Blockly.EchoDraw.forBlock['draw_set_thickness'] = function(b) { const w = Blockly.EchoDraw.valueToCode(b,'WIDTH',0)||'1'; return `set_thickness ${w}\n`; };
        Blockly.EchoDraw.forBlock['procedures_defnoreturn'] = function(b) { const f = b.getFieldValue('NAME'); const c = Blockly.EchoDraw.statementToCode(b, 'STACK'); return `define ${f}\n${c}end_define\n`; };
        Blockly.EchoDraw.forBlock['procedures_callnoreturn'] = function(b) { return `call ${b.getFieldValue('NAME')}\n`; };
        Blockly.EchoDraw.scrub_ = function(b, c) { const n = b.nextConnection && b.nextConnection.targetBlock(); return c + Blockly.EchoDraw.blockToCode(n); };

        const workspace = Blockly.inject('blocklyDiv', { toolbox: document.getElementById('toolbox') });
        
        workspace.addChangeListener(e => {
            const code = Blockly.EchoDraw.workspaceToCode(workspace);
            document.getElementById('code-editor').value = code;
        });

        // =================================================================
        // PART 2: THE TURTLE OBJECT
        // =================================================================

        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        const turtle = {
            x: 0, y: 0, angle: 0, penDown: true,
            reset: function() {
                this.x = canvas.width / 2; this.y = canvas.height / 2; this.angle = -90; this.penDown = true;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.strokeStyle = "black"; ctx.lineWidth = 2; ctx.lineCap = "round";
            },
            move: function(distance) {
                const startX = this.x; const startY = this.y;
                const rad = this.angle * (Math.PI / 180);
                this.x += Math.cos(rad) * distance; this.y += Math.sin(rad) * distance;
                if (this.penDown) { ctx.beginPath(); ctx.moveTo(startX, startY); ctx.lineTo(this.x, this.y); ctx.stroke(); }
            },
            turn: function(degrees) { this.angle += degrees; }
        };

        // =================================================================
        // PART 3: THE INTERPRETER ENGINE
        // =================================================================

        function runCode() {
            turtle.reset();
            const code = document.getElementById('code-editor').value;
            const allLines = code.split('\n');
            const functions = {};
            let mainProgram = [];
            let isDefining = false;
            let currentFunc = null;

            for (const line of allLines) {
                const trimmed = line.trim();
                const parts = trimmed.split(' ');
                if (parts[0] === 'define') {
                    isDefining = true;
                    currentFunc = parts[1];
                    functions[currentFunc] = [];
                } else if (parts[0] === 'end_define') {
                    isDefining = false;
                    currentFunc = null;
                } else if (isDefining) {
                    if (trimmed) functions[currentFunc].push(trimmed);
                } else {
                    if (trimmed) mainProgram.push(trimmed);
                }
            }

            function execute(lines) {
                for (let i = 0; i < lines.length; i++) {
                    const parts = lines[i].split(' ');
                    const command = parts[0];

                    if (command === 'move_forward') turtle.move(parseInt(parts[1]));
                    else if (command === 'turn_right') turtle.turn(parseInt(parts[1]));
                    else if (command === 'pen_up') turtle.penDown = false;
                    else if (command === 'pen_down') turtle.penDown = true;
                    else if (command === 'set_color') ctx.strokeStyle = parts[1];
                    else if (command === 'set_thickness') ctx.lineWidth = parseInt(parts[1]);
                    else if (command === 'call') {
                        if (functions[parts[1]]) execute(functions[parts[1]]);
                    } else if (command === 'repeat') {
                        const count = parseInt(parts[1]);
                        let body = [];
                        let level = 1;
                        let end = -1;
                        for (let j = i + 1; j < lines.length; j++) {
                            if (lines[j].startsWith('repeat')) level++;
                            if (lines[j] === 'end_repeat') level--;
                            if (level === 0) { end = j; break; }
                        }
                        if (end !== -1) {
                            body = lines.slice(i + 1, end);
                            for (let k = 0; k < count; k++) execute(body);
                            i = end;
                        }
                    }
                }
            }
            execute(mainProgram);
        }

        // =================================================================
        // PART 4: THE CREATOR'S TOOLKIT (SAVE, SHARE, LOAD)
        // =================================================================

        function saveDrawing() {
            const link = document.createElement('a');
            link.download = 'echodraw_creation.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function shareProgram() {
            const code = Blockly.EchoDraw.workspaceToCode(workspace); // Always share the blocks' code
            const encoded = btoa(code);
            const link = `${window.location.origin}${window.location.pathname}#code=${encoded}`;
            prompt("Copy this link to share your program:", link);
        }

        window.onload = function() {
            if (window.location.hash.startsWith('#code=')) {
                try {
                    const encoded = window.location.hash.substring(6);
                    const decoded = atob(encoded);
                    // This is complex, so we will just load the code into the editor for now
                    // A full block-reconstruction is a huge future step.
                    document.getElementById('code-editor').value = decoded;
                    runCode();
                } catch (e) {
                    console.error("Failed to load shared code:", e);
                }
            }
        };

    </script>
</body>
</html>
  </script>
</body>
</html>
